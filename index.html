<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>后天八卦 / 九宫 基础</title>
    <style>
        /* CSS: General Resets & Defaults */
        :root {
            --primary-text-color: #333;
            --secondary-text-color: #555;
            --border-color: #ddd;
            --highlight-color: #007bff;
            --highlight-text-color: #fff;
            --bg-color: #fff;
            --panel-bg-color: #f9f9f9;
            --button-bg-color: #f0f0f0;
            --button-hover-bg-color: #e0e0e0;
            --button-active-bg-color: #d0d0d0;
            --button-active-overlay-bg: #007bff;
            --button-active-overlay-text: #fff;
            --transition-speed: 0.3s;
            --font-sans-serif: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            --min-touch-target: 44px;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px; /* Base font size */
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-sans-serif);
            line-height: 1.6;
            color: var(--primary-text-color);
            background-color: var(--bg-color);
            padding-top: 70px; /* Space for fixed header */
            padding-bottom: 50px; /* Space for fixed footer */
        }

        /* CSS: Utility Classes */
        .sr-only { /* For screen readers only */
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .hidden {
            display: none !important;
        }

        /* CSS: Header & Language Switcher */
        .app-header {
            background-color: #fff;
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            min-height: 50px;
        }

        .app-title-main {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .language-switcher {
            display: flex;
            align-items: center;
        }

        .language-switcher label {
            margin-right: 8px;
            font-size: 0.9rem;
        }

        .language-switcher button {
            padding: 5px 0; /* Adjust padding to rely on min-width */
            margin-left: 5px;
            border: 1px solid var(--border-color);
            background-color: var(--button-bg-color);
            cursor: pointer;
            transition: background-color var(--transition-speed);
            font-size: 0.9rem;
            min-width: 60px; /* Added min-width */
            min-height: 38px; /* Added min-height */
            text-align: center; /* Ensure text is centered */
        }
        .language-switcher button:hover {
            background-color: var(--button-hover-bg-color);
        }
        .language-switcher button.active {
            background-color: var(--highlight-color);
            color: var(--highlight-text-color);
            border-color: var(--highlight-color);
        }


        /* CSS: Main Content Area & Controls */
        .main-content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .control-button {
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            background-color: var(--button-bg-color);
            cursor: pointer;
            transition: background-color var(--transition-speed), color var(--transition-speed);
            border-radius: 4px;
            font-size: 0.9rem;
            min-height: var(--min-touch-target);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .control-button:hover {
            background-color: var(--button-hover-bg-color);
        }
        .control-button:focus {
            outline: 2px solid var(--highlight-color);
            outline-offset: 2px;
        }
        .control-button.active {
            background-color: var(--button-active-overlay-bg);
            color: var(--button-active-overlay-text);
            border-color: var(--button-active-overlay-bg);
        }

        /* CSS: Ba Gua Grid */
        .bagua-grid-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr); /* Make rows equal height */
            gap: 5px; /* Adjust gap for better visual separation */
            max-width: 600px; /* Max width for the grid itself */
            margin: 20px auto; /* Center grid */
            border: 2px solid var(--primary-text-color);
            aspect-ratio: 1 / 1; /* Make it a square */
            position: relative; /* Added for absolute positioning of children in circular mode */
        }

        /* Styles for circular layout when mountains overlay is active */
        .bagua-grid-container.mountains-overlay-active {
            display: block; /* Override grid display */
            /* border-radius: 50%; Optional: if you want the container itself to be a circle */
        }

        .grid-cell {
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: background-color var(--transition-speed), transform var(--transition-speed);
            font-size: 0.8rem; /* Base size, can be adjusted */
            min-height: 100px; /* Ensure cells have some height */
        }
        .grid-cell:hover:not(.zhonggong) {
            background-color: #f0f0f0;
            transform: scale(1.03);
        }
        
        /* Disable default hover for outer cells in circular mode */
        .bagua-grid-container.mountains-overlay-active .grid-cell:not(.zhonggong):hover {
            background-color: transparent; /* Or original palace color if set */
            transform: none; /* Override scaling, JS handles positioning transform */
        }
        /* Add hover to segments themselves in circular mode */
        .bagua-grid-container.mountains-overlay-active .mountain-segment:hover {
             background-color: rgba(0,0,0,0.05); /* Subtle hover */
        }


        .grid-cell:focus:not(.zhonggong) {
            outline: 2px solid var(--highlight-color);
            outline-offset: -2px;
        }
        .grid-cell.active-selection {
            box-shadow: 0 0 0 3px var(--highlight-color) inset;
        }
        .bagua-grid-container.mountains-overlay-active .grid-cell.active-selection {
             /* Ensure selection is visible on potentially transparent cells */
            /* box-shadow: 0 0 0 3px var(--highlight-color); /* Outer glow might be better */
        }
         .bagua-grid-container.mountains-overlay-active .mountain-segment.active-selection {
            box-shadow: 0 0 0 2px var(--highlight-color) inset;
        }


        .grid-cell .trigram-symbol {
            font-size: 1.8em; /* Relative to cell font-size */
            margin-bottom: 5px;
            line-height: 1;
        }
        .grid-cell .palace-name {
            font-weight: bold;
            margin-bottom: 3px;
        }
        .grid-cell .direction-name {
            font-size: 0.9em;
            color: var(--secondary-text-color);
        }
        .grid-cell .gate-name-overlay {
            margin-top: 8px;
            font-size: 0.9em;
            color: var(--highlight-color);
            font-weight: bold;
        }
        .grid-cell .zhonggong-star {
            font-size: 2em;
            color: var(--primary-text-color);
        }

        .grid-cell.zhonggong {
            background-color: #e9e9e9;
            cursor: default;
            font-weight: bold;
        }
        .grid-cell.zhonggong:hover {
            transform: none;
        }

        /* 24 Mountains Segments styling */
        .mountains-overlay-active .grid-cell:not(.zhonggong) {
            padding: 0; /* Remove padding to allow segments to fill cell */
            flex-direction: row; /* For horizontal segments */
            align-items: stretch; /* Make segments fill height */
            justify-content: space-around; /* Distribute segments */
            border: none; /* Hide border of the cell itself in circular mode */
        }

        .mountain-segment {
            flex-grow: 1;
            flex-basis: 0; /* Equal width */
            border-left: 1px dashed #ccc;
            display: flex;
            flex-direction: column; /* Stack content within segment */
            align-items: center;
            justify-content: center;
            padding: 5px; /* Padding inside segment */
            font-size: 0.7rem; /* Smaller font for mountain names */
            height: 100%; /* Fill cell height */
            position: relative; /* For absolute positioned content if needed */
        }
        .mountain-segment:first-child {
            border-left: none;
        }
        .mountain-segment .mountain-char {
            font-size: 1.5em; /* Relative to segment font-size */
            font-weight: bold;
            display: block;
            margin-bottom: 3px;
        }
        .mountain-segment .palace-info-condensed {
            font-size: 0.8em;
            display: block; /* Allow multiple lines */
            line-height: 1.2;
        }
        .mountain-segment .trigram-symbol-condensed {
             font-size: 1.2em;
        }

        /* CSS: Information Panel */
        .info-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-speed) ease, visibility 0s var(--transition-speed) linear;
        }
        .info-panel-overlay.visible {
            opacity: 1;
            visibility: visible;
            transition-delay: 0s;
        }

        .info-panel {
            background-color: var(--panel-bg-color);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            transform: scale(0.95);
            transition: transform var(--transition-speed) ease;
        }
        .info-panel-overlay.visible .info-panel {
            transform: scale(1);
        }

        .info-panel-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            line-height: 1;
            padding: 5px;
            color: var(--secondary-text-color);
        }
        .info-panel-close:hover {
            color: var(--primary-text-color);
        }

        .info-panel h2 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: var(--highlight-color);
        }
        .info-panel h3 {
            font-size: 1.2rem;
            margin-top: 20px;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }
        .info-panel p, .info-panel li {
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        .info-panel strong {
            font-weight: bold;
        }
        .info-panel .trigram-symbol-large {
            font-size: 3em;
            float: right;
            margin-left: 10px;
            line-height: 1;
        }
        .info-panel ul {
            list-style-position: inside;
            padding-left: 0;
        }
        .info-panel hr {
            border: 0;
            border-top: 1px dashed var(--border-color);
            margin: 15px 0;
        }
        .info-panel-section-collapsible summary {
            cursor: pointer;
            font-weight: bold;
            padding: 5px;
            background-color: #e8e8e8;
            margin-bottom: 5px;
            border-radius: 3px;
        }
        .info-panel-section-collapsible summary:hover {
            background-color: #d8d8d8;
        }
         .info-panel-section-collapsible[open] summary {
            margin-bottom: 10px;
        }


        /* CSS: Static Informational Sections */
        .static-info-sections {
            margin-top: 40px;
        }
        .info-section {
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        .info-section summary {
            padding: 10px 15px;
            font-weight: bold;
            cursor: pointer;
            background-color: #f7f7f7;
            border-bottom: 1px solid var(--border-color);
            transition: background-color var(--transition-speed);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .info-section summary:hover {
            background-color: #efefef;
        }
        .info-section summary::after {
            content: '▼'; /* Down arrow */
            font-size: 0.8em;
            transition: transform var(--transition-speed);
        }
        .info-section[open] summary::after {
            transform: rotate(180deg); /* Up arrow */
        }
        .info-section[open] summary {
            border-bottom: 1px solid var(--border-color);
        }
        .info-section-content {
            padding: 15px;
            font-size: 0.95rem;
        }
        .info-section-content h4 {
            font-size: 1.1rem;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .info-section-content p, .info-section-content ul, .info-section-content dl {
            margin-bottom: 10px;
        }
        .info-section-content ul {
            padding-left: 20px;
        }
        .info-section-content dt {
            font-weight: bold;
        }
        .info-section-content dd {
            margin-left: 20px;
            margin-bottom: 8px;
        }
        .wuxing-diagram-placeholder, .luopan-subdivision-placeholder {
            /* Basic placeholder styling, SVG will replace this */
            min-height: 150px;
            background-color: #eee;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            margin: 10px 0;
            padding: 10px;
        }
        .wuxing-diagram-placeholder svg, .luopan-subdivision-placeholder svg {
            max-width: 100%;
            height: auto;
        }

        /* CSS: Footer */
        .app-footer {
            text-align: center;
            padding: 15px;
            font-size: 0.9rem;
            color: var(--secondary-text-color);
            border-top: 1px solid var(--border-color);
            background-color: #f9f9f9;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            min-height: 40px;
        }

        /* CSS: Responsive Adjustments */
        @media (max-width: 768px) {
            body {
                padding-top: 100px; /* More space for potentially wrapped header items */
            }
            .app-header {
                flex-direction: column;
                align-items: flex-start;
                padding-bottom: 5px; /* Adjust if title wraps */
            }
            .app-title-main {
                margin-bottom: 8px;
                font-size: 1.1rem;
            }
            .language-switcher {
                 align-self: flex-end; /* Align to right if header wraps */
            }
            
            .bagua-grid-container {
                 max-width: 90vw; /* Allow grid to shrink more on smaller screens */
            }

            .grid-cell {
                font-size: 0.7rem; /* Smaller base font for cells on mobile */
                min-height: 80px;
            }
            .grid-cell .trigram-symbol {
                font-size: 1.6em;
            }
             .mountain-segment {
                font-size: 0.6rem; /* Further reduce for mountain chars */
            }
            .mountain-segment .mountain-char {
                font-size: 1.3em;
            }


            .info-panel {
                width: 95%;
                max-height: 90vh;
                padding: 20px;
            }
            .info-panel h2 {
                font-size: 1.3rem;
            }
            .info-panel h3 {
                font-size: 1.1rem;
            }
            .info-panel p, .info-panel li {
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .controls {
                flex-direction: column; /* Stack control buttons */
            }
            .control-button {
                width: 100%; /* Full width buttons */
            }

            .grid-cell {
                padding: 5px; /* Reduce padding on very small screens */
                font-size: 0.6rem;
            }
             .grid-cell .trigram-symbol {
                font-size: 1.5em;
            }
             .mountain-segment {
                font-size: 0.55rem;
            }
            .mountain-segment .mountain-char {
                font-size: 1.2em;
            }
            .grid-cell .gate-name-overlay {
                font-size: 0.8em;
            }

            .info-panel-close {
                font-size: 1.5rem;
                top: 5px;
                right: 5px;
            }
        }

    </style>
</head>
<body>

    <header class="app-header">
        <h1 class="app-title-main" data-translate-key="appTitle"></h1>
        <div class="language-switcher">
            <span data-translate-key="langSwitchLabel"></span>
            <button id="lang-zh" aria-pressed="true">中文</button>
            <button id="lang-en" aria-pressed="false">EN</button>
        </div>
    </header>

    <main class="main-content">
        <div class="controls">
            <button id="qimen-toggle" class="control-button" data-translate-key-on="hideQimenGates" data-translate-key-off="showQimenGates" aria-pressed="false"></button>
            <button id="mountains-toggle" class="control-button" data-translate-key-on="hide24Mountains" data-translate-key-off="show24Mountains" aria-pressed="false"></button>
        </div>

        <div id="bagua-grid" class="bagua-grid-container" role="grid">
            <!-- Grid cells will be generated by JavaScript -->
        </div>
    </main>

    <div id="info-panel-overlay" class="info-panel-overlay" role="dialog" aria-modal="true" aria-labelledby="info-panel-title">
        <div id="info-panel" class="info-panel">
            <button id="info-panel-close" class="info-panel-close" aria-label="Close panel">&times;</button>
            <div id="info-panel-content">
                <!-- Info panel content will be generated by JavaScript -->
            </div>
        </div>
    </div>

    <section class="static-info-sections" aria-label="Additional Information">
        <details class="info-section" id="how-to-use">
            <summary data-translate-key="howToUseTitle"></summary>
            <div class="info-section-content" data-translate-key="howToUseContent" data-html-content="true"></div>
        </details>
        <details class="info-section" id="about-wuxing">
            <summary data-translate-key="aboutWuXingTitle"></summary>
            <div class="info-section-content" data-translate-key="aboutWuXingContent" data-html-content="true"></div>
        </details>
        <details class="info-section" id="about-directions">
            <summary data-translate-key="aboutDirectionsTitle"></summary>
            <div class="info-section-content" data-translate-key="aboutDirectionsContent" data-html-content="true"></div>
        </details>
        <details class="info-section" id="about-app">
            <summary data-translate-key="aboutAppTitle"></summary>
            <div class="info-section-content" data-translate-key="aboutAppContent" data-html-content="true"></div>
        </details>
        <details class="info-section" id="glossary">
            <summary data-translate-key="glossaryTitle"></summary>
            <div class="info-section-content" data-translate-key="glossaryContent" data-html-content="true"></div>
        </details>
    </section>

    <footer class="app-footer">
        <p><span data-translate-key="courseName"></span></p>
    </footer>

    <script>
    // JavaScript: Application Logic
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA STORE ---
        const appData = {
            settings: {
                currentLang: 'zh',
                defaultLang: 'zh',
                qimenOverlayActive: false,
                mountainsOverlayActive: false,
                selectedElementId: null, // e.g., 'palace-kan', 'mountain-zi'
            },
            palaceOrder: ['xun', 'li', 'kun', 'zhen', 'zhonggong', 'dui', 'gen', 'kan', 'qian'], // For 3x3 grid rendering order
            palaces: {
                xun: { trigramSymbol: "☴", elementId: 'wood', color: 'rgba(144, 238, 144, 0.5)', mountains: ['chen', 'xun_m', 'si'], gateId: 'du', nameKey: 'palaceXun', dirKey: 'dirSE', dirDetailKey: 'palaceXunDirDetail', qualitiesKey: 'qualitiesXun', enhancementKey: 'enhanceXun' },
                li: { trigramSymbol: "☲", elementId: 'fire', color: 'rgba(240, 128, 128, 0.5)', mountains: ['bing', 'wu', 'ding'], gateId: 'jing', nameKey: 'palaceLi', dirKey: 'dirS', dirDetailKey: 'palaceLiDirDetail', qualitiesKey: 'qualitiesLi', enhancementKey: 'enhanceLi' },
                kun: { trigramSymbol: "☷", elementId: 'earth', color: 'rgba(240, 230, 140, 0.5)', mountains: ['wei', 'kun_m', 'shen'], gateId: 'si_g', nameKey: 'palaceKun', dirKey: 'dirSW', dirDetailKey: 'palaceKunDirDetail', qualitiesKey: 'qualitiesKun', enhancementKey: 'enhanceKun' },
                zhen: { trigramSymbol: "☳", elementId: 'wood', color: 'rgba(144, 238, 144, 0.5)', mountains: ['jia', 'mao', 'yi'], gateId: 'shang', nameKey: 'palaceZhen', dirKey: 'dirE', dirDetailKey: 'palaceZhenDirDetail', qualitiesKey: 'qualitiesZhen', enhancementKey: 'enhanceZhen' },
                zhonggong: { trigramSymbol: "", elementId: 'earth', color: '#e9e9e9', mountains: [], gateId: null, nameKey: 'palaceZhonggong', dirKey: 'dirCenter', qualitiesKey: null, enhancementKey: null },
                dui: { trigramSymbol: "☱", elementId: 'metal', color: 'rgba(211, 211, 211, 0.5)', mountains: ['geng', 'you', 'xin'], gateId: 'jing_j', nameKey: 'palaceDui', dirKey: 'dirW', dirDetailKey: 'palaceDuiDirDetail', qualitiesKey: 'qualitiesDui', enhancementKey: 'enhanceDui' },
                gen: { trigramSymbol: "☶", elementId: 'earth', color: 'rgba(240, 230, 140, 0.5)', mountains: ['chou', 'gen_m', 'yin'], gateId: 'sheng', nameKey: 'palaceGen', dirKey: 'dirNE', dirDetailKey: 'palaceGenDirDetail', qualitiesKey: 'qualitiesGen', enhancementKey: 'enhanceGen' },
                kan: { trigramSymbol: "☵", elementId: 'water', color: 'rgba(173, 216, 230, 0.5)', mountains: ['ren', 'zi', 'gui'], gateId: 'xiu', nameKey: 'palaceKan', dirKey: 'dirN', dirDetailKey: 'palaceKanDirDetail', qualitiesKey: 'qualitiesKan', enhancementKey: 'enhanceKan' },
                qian: { trigramSymbol: "☰", elementId: 'metal', color: 'rgba(211, 211, 211, 0.5)', mountains: ['xu', 'qian_m', 'hai'], gateId: 'kai', nameKey: 'palaceQian', dirKey: 'dirNW', dirDetailKey: 'palaceQianDirDetail', qualitiesKey: 'qualitiesQian', enhancementKey: 'enhanceQian' }
            },
            elements: { // In Wu Xing, 'controls' is often termed 'restricts' or 'overcomes'. '克 kè' is used.
                water: { nameKey: 'elementWater', generates: 'wood', controls: 'fire', generatedBy: 'metal', controlledBy: 'earth' },
                wood:  { nameKey: 'elementWood', generates: 'fire', controls: 'earth', generatedBy: 'water', controlledBy: 'metal' },
                fire:  { nameKey: 'elementFire', generates: 'earth', controls: 'metal', generatedBy: 'wood', controlledBy: 'water' },
                earth: { nameKey: 'elementEarth', generates: 'metal', controls: 'water', generatedBy: 'fire', controlledBy: 'wood' },
                metal: { nameKey: 'elementMetal', generates: 'water', controls: 'wood', generatedBy: 'earth', controlledBy: 'fire' },
            },
            gates: { // "Gate" changed to "Door" in English where applicable, keys remain 'gate' for consistency.
                xiu:    { originalPalaceId: 'kan',  elementId: 'water', nameKey: 'gateXiu',    propertiesKey: 'gateXiuProperties', shortNameKey: 'gateXiuShort' },
                sheng:  { originalPalaceId: 'gen',  elementId: 'earth', nameKey: 'gateSheng',  propertiesKey: 'gateShengProperties', shortNameKey: 'gateShengShort' },
                shang:  { originalPalaceId: 'zhen', elementId: 'wood',  nameKey: 'gateShang',  propertiesKey: 'gateShangProperties', shortNameKey: 'gateShangShort' },
                du:     { originalPalaceId: 'xun',  elementId: 'wood',  nameKey: 'gateDu',     propertiesKey: 'gateDuProperties', shortNameKey: 'gateDuShort' },
                jing:   { originalPalaceId: 'li',   elementId: 'fire',  nameKey: 'gateJing',   propertiesKey: 'gateJingProperties', shortNameKey: 'gateJingShort' },
                si_g:   { originalPalaceId: 'kun',  elementId: 'earth', nameKey: 'gateSi',     propertiesKey: 'gateSiProperties', shortNameKey: 'gateSiShort' }, // gateSi refers to 死门
                jing_j: { originalPalaceId: 'dui',  elementId: 'metal', nameKey: 'gateJing2',  propertiesKey: 'gateJing2Properties', shortNameKey: 'gateJing2Short' }, // gateJing2 refers to 惊门
                kai:    { originalPalaceId: 'qian', elementId: 'metal', nameKey: 'gateKai',    propertiesKey: 'gateKaiProperties', shortNameKey: 'gateKaiShort' }
            },
            mountains: {
                ren:    { parentPalaceId: 'kan', degreeRange: "337.5° - 352.5°", nameKey: "mountainRen", fullNameKey: "mountainRenFull", implicationKey: "mountainRenImplication" },
                zi:     { parentPalaceId: 'kan', degreeRange: "352.5° - 7.5°",   nameKey: "mountainZi",  fullNameKey: "mountainZiFull",  implicationKey: "mountainZiImplication" },
                gui:    { parentPalaceId: 'kan', degreeRange: "7.5° - 22.5°",    nameKey: "mountainGui", fullNameKey: "mountainGuiFull", implicationKey: "mountainGuiImplication" },
                chou:   { parentPalaceId: 'gen', degreeRange: "22.5° - 37.5°",   nameKey: "mountainChou", fullNameKey: "mountainChouFull", implicationKey: "mountainChouImplication" },
                gen_m:  { parentPalaceId: 'gen', degreeRange: "37.5° - 52.5°",   nameKey: "mountainGenM",  fullNameKey: "mountainGenMFull",  implicationKey: "mountainGenMImplication" }, 
                yin:    { parentPalaceId: 'gen', degreeRange: "52.5° - 67.5°",   nameKey: "mountainYin", fullNameKey: "mountainYinFull", implicationKey: "mountainYinImplication" },
                jia:    { parentPalaceId: 'zhen', degreeRange: "67.5° - 82.5°",  nameKey: "mountainJia", fullNameKey: "mountainJiaFull", implicationKey: "mountainJiaImplication" },
                mao:    { parentPalaceId: 'zhen', degreeRange: "82.5° - 97.5°",  nameKey: "mountainMao", fullNameKey: "mountainMaoFull", implicationKey: "mountainMaoImplication" },
                yi:     { parentPalaceId: 'zhen', degreeRange: "97.5° - 112.5°", nameKey: "mountainYi",  fullNameKey: "mountainYiFull",  implicationKey: "mountainYiImplication" },
                chen:   { parentPalaceId: 'xun', degreeRange: "112.5° - 127.5°", nameKey: "mountainChen",fullNameKey: "mountainChenFull", implicationKey: "mountainChenImplication" },
                xun_m:  { parentPalaceId: 'xun', degreeRange: "127.5° - 142.5°", nameKey: "mountainXunM", fullNameKey: "mountainXunMFull", implicationKey: "mountainXunMImplication" },
                si:     { parentPalaceId: 'xun', degreeRange: "142.5° - 157.5°", nameKey: "mountainSiM",  fullNameKey: "mountainSiMFull",  implicationKey: "mountainSiMImplication" }, 
                bing:   { parentPalaceId: 'li', degreeRange: "157.5° - 172.5°", nameKey: "mountainBing",fullNameKey: "mountainBingFull", implicationKey: "mountainBingImplication" },
                wu:     { parentPalaceId: 'li', degreeRange: "172.5° - 187.5°", nameKey: "mountainWu",  fullNameKey: "mountainWuFull",  implicationKey: "mountainWuImplication" },
                ding:   { parentPalaceId: 'li', degreeRange: "187.5° - 202.5°", nameKey: "mountainDing",fullNameKey: "mountainDingFull", implicationKey: "mountainDingImplication" },
                wei:    { parentPalaceId: 'kun', degreeRange: "202.5° - 217.5°", nameKey: "mountainWei", fullNameKey: "mountainWeiFull", implicationKey: "mountainWeiImplication" },
                kun_m:  { parentPalaceId: 'kun', degreeRange: "217.5° - 232.5°", nameKey: "mountainKunM", fullNameKey: "mountainKunMFull", implicationKey: "mountainKunMImplication" },
                shen:   { parentPalaceId: 'kun', degreeRange: "232.5° - 247.5°", nameKey: "mountainShen",fullNameKey: "mountainShenFull", implicationKey: "mountainShenImplication" },
                geng:   { parentPalaceId: 'dui', degreeRange: "247.5° - 262.5°", nameKey: "mountainGeng",fullNameKey: "mountainGengFull", implicationKey: "mountainGengImplication" },
                you:    { parentPalaceId: 'dui', degreeRange: "262.5° - 277.5°", nameKey: "mountainYou", fullNameKey: "mountainYouFull", implicationKey: "mountainYouImplication" },
                xin:    { parentPalaceId: 'dui', degreeRange: "277.5° - 292.5°", nameKey: "mountainXin", fullNameKey: "mountainXinFull", implicationKey: "mountainXinImplication" },
                xu:     { parentPalaceId: 'qian', degreeRange: "292.5° - 307.5°", nameKey: "mountainXu",  fullNameKey: "mountainXuFull",  implicationKey: "mountainXuImplication" },
                qian_m: { parentPalaceId: 'qian', degreeRange: "307.5° - 322.5°", nameKey: "mountainQianM", fullNameKey: "mountainQianMFull", implicationKey: "mountainQianMImplication" },
                hai:    { parentPalaceId: 'qian', degreeRange: "322.5° - 337.5°", nameKey: "mountainHai", fullNameKey: "mountainHaiFull", implicationKey: "mountainHaiImplication" },
            },
            content: {
                zh: {
                    appTitle: "后天八卦 / 九宫 基础", courseName: "奇门/风水入门课程", // Updated courseName as per diff header's implication
                    langSwitchLabel: "语言:",
                    showQimenGates: "显示奇门八门", hideQimenGates: "隐藏奇门八门",
                    show24Mountains: "显示二十四山", hide24Mountains: "隐藏二十四山",
                    infoPanelClose: "关闭", zhongGongLabel: "中宫", qimenStarSymbol: "★",
                    infoPanelTitleDefault: "信息",
                    infoPanelTitlePalace: "{palaceName} 宫",
                    infoPanelTitleMountain: "{mountainName}",

                    palaceXun: "巽", palaceLi: "离", palaceKun: "坤", palaceZhen: "震", palaceZhonggong: "中宫", palaceDui: "兑", palaceGen: "艮", palaceKan: "坎", palaceQian: "乾",
                    dirSE: "东南", dirS: "南", dirSW: "西南", dirE: "东", dirCenter: "中央", dirW: "西", dirNE: "东北", dirN: "北", dirNW: "西北",

                    palaceXunDirDetail: "东南 (概念上包含辰、巽、巳三山，用于风水精确定向)",
                    palaceLiDirDetail: "南 (概念上包含丙、午、丁三山，用于风水精确定向)",
                    palaceKunDirDetail: "西南 (概念上包含未、坤、申三山，用于风水精确定向)",
                    palaceZhenDirDetail: "东 (概念上包含甲、卯、乙三山，用于风水精确定向)",
                    palaceDuiDirDetail: "西 (概念上包含庚、酉、辛三山，用于风水精确定向)",
                    palaceGenDirDetail: "东北 (概念上包含丑、艮、寅三山，用于风水精确定向)",
                    palaceKanDirDetail: "北 (概念上包含壬、子、癸三山，用于风水精确定向)",
                    palaceQianDirDetail: "西北 (概念上包含戌、乾、亥三山，用于风水精确定向)",

                    elementWater: "水", elementWood: "木", elementFire: "火", elementEarth: "土", elementMetal: "金",

                    qualitiesXun: "巽代表风、进入、顺从。", 
                    qualitiesLi: "离代表火、光明、美丽。", 
                    qualitiesKun: "坤代表地、柔顺、滋养。",
                    qualitiesZhen: "震代表雷、行动、奋起。", 
                    qualitiesDui: "兑代表泽、喜悦、言说。", 
                    qualitiesGen: "艮代表山、开垦、稳定。", // Updated
                    qualitiesKan: "坎代表水、险陷、智慧。", 
                    qualitiesQian: "乾代表天、刚健、领导。",

                    enhanceXun: "东南方的木元素可增强成长与发展。", 
                    enhanceLi: "南方的火元素可增强声誉与认可。", // Updated
                    enhanceKun: "西南方的土元素可增强稳定与关系。", 
                    enhanceZhen: "东方的木元素可增强动力与新开始。",
                    enhanceDui: "西方的金元素可增强表达能力与喜悦之气。", // Updated
                    enhanceGen: "东北方的土元素可增强知识与自我成长。",
                    enhanceKan: "北方的水元素可增强抗压性与智慧。", // Updated
                    enhanceQian: "西北方的金元素可增强发奋图强之势与权威。", // Updated

                    wuXingInteractionsTitle: "五行生克",
                    generatesLabel: "生 (shēng)", 
                    controlsLabel: "克 (kè)", // Will be mapped to "RestrictedLabel" for English
                    isGeneratedByLabel: "被生 (bèi shēng)", 
                    isControlledByLabel: "被克 (bèi kè)", // Will be mapped to "IsRestrictedByLabel" for English
                    
                    gateXiu: "休门 (Xiū Mén)", gateSheng: "生门 (Shēng Mén)", gateShang: "伤门 (Shāng Mén)",
                    gateDu: "杜门 (Dù Mén)", gateJing: "景门 (Jǐng Mén)", gateSi: "死门 (Sǐ Mén)",
                    gateJing2: "惊门 (Jīng Mén)", gateKai: "开门 (Kāi Mén)",

                    gateXiuShort: "休", gateShengShort: "生", gateShangShort: "伤", gateDuShort: "杜",
                    gateJingShort: "景", gateSiShort: "死", gateJing2Short: "惊", gateKaiShort: "开",

                    gateXiuProperties: "休门通常利于休养生息、修整、修行。", // Updated
                    gateShengProperties: "生门通常利于求财、生意、生命力。",
                    gateShangProperties: "伤门通常与伤害、竞争、索取有关。",
                    gateDuProperties: "杜门通常与隐藏、闭塞、技术有关。",
                    gateJingProperties: "景门通常与文书、策划、愿景、美丽有关。", // Updated
                    gateSiProperties: "死门通常与结束、不动产、安静有关。", // Updated
                    gateJing2Properties: "惊门通常与口才、口舌、官非、惊恐有关。", // Updated
                    gateKaiProperties: "开门通常利于开创事业、出行、谒贵。",

                    qimenInteractionTitle: "奇门概念",
                    qimenFundamentalState: "基本状态：在此视图中，{gateName} 在其本宫 ({palaceName})，其元素 ({gateElement}) 与宫位元素 ({palaceElement}) 一致。",
                    qimenCourseInsight: "课程重点：奇门/风水入门课程系统讲解奇门遁甲与风水堪舆的核心基础理论，将奇门遁甲中吉凶判断体系深度融入风水堪舆实践，通过对人事与环境因素的综合分析，帮助学员掌握趋吉避凶的实用方法，实现个人财富、事业和健康运势的提升。", // Updated
                    gateOriginalPalace: "源于宫位", derivedElement: "衍生五行",

                    mountainRen: "壬", mountainZi: "子", mountainGui: "癸", mountainChou: "丑", mountainGenM: "艮", mountainYin: "寅",
                    mountainJia: "甲", mountainMao: "卯", mountainYi: "乙", mountainChen: "辰", mountainXunM: "巽", mountainSiM: "巳",
                    mountainBing: "丙", mountainWu: "午", mountainDing: "丁", mountainWei: "未", mountainKunM: "坤", mountainShen: "申",
                    mountainGeng: "庚", mountainYou: "酉", mountainXin: "辛", mountainXu: "戌", mountainQianM: "乾", mountainHai: "亥",

                    mountainRenFull: "壬 (Rén) 山", mountainZiFull: "子 (Zǐ) 山", mountainGuiFull: "癸 (Guǐ) 山",
                    mountainChouFull: "丑 (Chǒu) 山", mountainGenMFull: "艮 (Gèn) 山", mountainYinFull: "寅 (Yín) 山",
                    mountainJiaFull: "甲 (Jiǎ) 山", mountainMaoFull: "卯 (Mǎo) 山", mountainYiFull: "乙 (Yǐ) 山",
                    mountainChenFull: "辰 (Chén) 山", mountainXunMFull: "巽 (Xùn) 山", mountainSiMFull: "巳 (Sì) 山",
                    mountainBingFull: "丙 (Bǐng) 山", mountainWuFull: "午 (Wǔ) 山", mountainDingFull: "丁 (Dīng) 山",
                    mountainWeiFull: "未 (Wèi) 山", mountainKunMFull: "坤 (Kūn) 山", mountainShenFull: "申 (Shēn) 山",
                    mountainGengFull: "庚 (Gēng) 山", mountainYouFull: "酉 (Yǒu) 山", mountainXinFull: "辛 (Xīn) 山",
                    mountainXuFull: "戌 (Xū) 山", mountainQianMFull: "乾 (Qián) 山", mountainHaiFull: "亥 (Hài) 山",

                    mountainParentPalace: "所属宫位", mountainDirectionSuffix: "方向", mountainApproxDegrees: "大约度数",
                    mountainInheritedElement: "主要五行",
                    mountainInheritedElementNote: "(源自 {palaceName} 宫)。具体的山向五行细微差别将在‘奇门/风水入门’课程中探讨。", // Course name updated
                    mountainFengShuiImplication: "风水含义",
                    mountainCourseRelevance: "课程关联",
                    mountainCourseRelevanceText: "课程核心：使用罗盘准确确定房屋的坐山/朝向（例如 {mountainName}）是‘奇门/风水入门’课程中叠加和解读奇门遁甲盘的关键第一步。", // Course name updated
                    qimenGateInThisSector: "此区域奇门",
                    qimenGateInThisSectorSuffix: "(在此基础视图中占据 {palaceName} 宫)",

                    mountainRenImplication: "壬山：水之旺位，北方偏西北。用于精确调整。",
                    mountainZiImplication: "子山：正北方，水之帝旺。关键定向。",
                    mountainGuiImplication: "癸山：水之余气，北方偏东北。细节调整。",
                    mountainChouImplication: "丑山：东北方，土中带金。稳定与积累。",
                    mountainGenMImplication: "艮山：正东北，土之本位。学识与静止。",
                    mountainYinImplication: "寅山：东北方，木之初生。新生与活力。",
                    mountainJiaImplication: "甲山：东方，木之强旺。开创与进取。",
                    mountainMaoImplication: "卯山：正东方，木之帝旺。繁荣与发展。",
                    mountainYiImplication: "乙山：东方，木之柔韧。策划与适应。",
                    mountainChenImplication: "辰山：东南方，土中带水。变化与机遇。",
                    mountainXunMImplication: "巽山：正东南，木之成熟。顺风与名声。",
                    mountainSiMImplication: "巳山：东南方，火之初生。热情与传播。",
                    mountainBingImplication: "丙山：南方，火之强旺。光明与权势。",
                    mountainWuImplication: "午山：正南方，火之帝旺。顶峰与热烈。",
                    mountainDingImplication: "丁山：南方，火之柔光。智慧与细致。",
                    mountainWeiImplication: "未山：西南方，土中带火。滋养与人脉。",
                    mountainKunMImplication: "坤山：正西南，土之本位。包容与母性。",
                    mountainShenImplication: "申山：西南方，金之初生。坚毅与变通。",
                    mountainGengImplication: "庚山：西方，金之强旺。决断与收获。",
                    mountainYouImplication: "酉山：正西方，金之帝旺。成果与喜悦。",
                    mountainXinImplication: "辛山：西方，金之精锐。珠宝与魅力。",
                    mountainXuImplication: "戌山：西北方，土中带金。守护与仓库。",
                    mountainQianMImplication: "乾山：正西北，金之本位。领导与天运。",
                    mountainHaiImplication: "亥山：西北方，水之初生。智慧与流动。",

                    howToUseTitle: "如何使用此应用", aboutWuXingTitle: "关于五行", aboutDirectionsTitle: "关于方位、罗盘与二十四山",
                    aboutAppTitle: "关于此应用与课程后续", glossaryTitle: "术语表",
                    howToUseContent: `<p>欢迎使用后天八卦与奇门遁甲基础学习工具！</p><ul><li><strong>点击八卦单元格：</strong>查看该宫位的详细信息。</li><li><strong>切换奇门八门：</strong>在八卦图上叠加显示各宫对应的原始八门。</li><li><strong>切换二十四山：</strong>将每个八卦宫位细分为三个山向。点击具体的山向可查看其详细信息。</li><li><strong>信息面板：</strong>点击单元格或山向后，右侧会弹出信息面板。</li><li><strong>语言切换：</strong>使用页面顶部的语言切换器选择显示语言。</li></ul>`,
                    aboutWuXingContent: `<h4>五行 (Wǔ Xíng)</h4><p>五行（水、木、火、土、金）是中国哲学中描述物质世界相互作用的基本概念。它们之间存在相生和相克的关系：</p><p><strong>相生 (Xiāng Shēng):</strong> <span class="wuxing-diagram-placeholder" data-diagram-type="generating" aria-label="五行相生图：水生木，木生火，火生土，土生金，金生水">水 → 木 → 火 → 土 → 金 → 水</span></p><p><strong>相克 (Xiāng Kè):</strong> <span class="wuxing-diagram-placeholder" data-diagram-type="controlling" aria-label="五行相克图：水克火，火克金，金克木，木克土，土克水">水 ✗ 火 ✗ 金 ✗ 木 ✗ 土 ✗ 水</span></p>`,
                    aboutDirectionsContent: `<h4>方位、罗盘 (Luópán) 与二十四山 (Èrshísì Shān)</h4><p>后天八卦定义了八个基本方位，每个方位覆盖45度。为了更精确，每个方位被细分为三个“山”，共二十四山，每山15度。例如，北方 (坎宫) 包含壬、子、癸三山。<span class="luopan-subdivision-placeholder" aria-label="八卦方位细分为二十四山的示意图"></span> 罗盘是精确测量这些方位和山向的关键工具。</p>`,
                    aboutAppContent: `<h4>关于此应用与‘奇门/风水入门’课程后续步骤</h4><p>本应用旨在帮助您熟悉后天八卦、五行基础以及奇门遁甲八门在其原始宫位的基本概念。这为“奇门/风水入门”课程打下坚实的基础。</p><p>在“奇门/风水入门”课程中，您将学习动态奇门盘、识别“四害”及其实际应用。</p>`, // Course name updated
                    glossaryContent: `<h4>术语表</h4><dl><dt>后天八卦 (Hòutiān Bāguà)</dt><dd>空间与时间周期的描述序列。</dd><dt>五行 (Wǔ Xíng)</dt><dd>水、木、火、土、金五种元素及其互动。</dd><dt>奇门遁甲 (Qímén Dùnjiǎ)</dt><dd>古代预测与决策术数。</dd><dt>八门 (Bā Mén)</dt><dd>奇门中的八个主要“门”。</dd><dt>二十四山 (Èrshísì Shān)</dt><dd>罗盘360度细分为24等份，每份15度。</dd></dl>`,
                    
                    palaceInfoSection: "宫位信息",
                    wuXingInfoSection: "五行信息", // Used as section title in panel
                    qimenGateInfoSection: "八门信息", // Updated
                    mountainInfoSection: "山向信息",
                    parentPalaceBriefSection: "所属宫位 (简要)"
                },
                en: {
                    appTitle: "Later Heaven Ba Gua / Nine Palaces Foundations", courseName: "Qimen / FengShui Foundations Course", // Updated
                    langSwitchLabel: "Language:",
                    showQimenGates: "Show Qimen Gates", hideQimenGates: "Hide Qimen Gates", // "Gates" retained for button consistency, panel will show "Doors"
                    show24Mountains: "Show 24 Mountains", hide24Mountains: "Hide 24 Mountains",
                    infoPanelClose: "Close", zhongGongLabel: "Central Palace", qimenStarSymbol: "★",
                    infoPanelTitleDefault: "Information",
                    infoPanelTitlePalace: "{palaceName} Palace",
                    infoPanelTitleMountain: "{mountainName} Mountain",

                    palaceXun: "Xun", palaceLi: "Li", palaceKun: "Kun", palaceZhen: "Zhen", palaceZhonggong: "Zhong Gong", palaceDui: "Dui", palaceGen: "Gen", palaceKan: "Kan", palaceQian: "Qian",
                    dirSE: "Southeast", dirS: "South", dirSW: "Southwest", dirE: "East", dirCenter: "Center", dirW: "West", dirNE: "Northeast", dirN: "North", dirNW: "Northwest",

                    palaceXunDirDetail: "Southeast (conceptually encompassing Chen（辰）, Xun（巽）, Si（巳） mountains for precise Feng Shui orientation)", // Updated
                    palaceLiDirDetail: "South (conceptually encompassing Bing（丙）, Wu（午）, Ding（丁） mountains for precise Feng Shui orientation)", // Updated
                    palaceKunDirDetail: "Southwest (conceptually encompassing Wei（未）, Kun（坤）, Shen（申） mountains for precise Feng Shui orientation)", // Updated
                    palaceZhenDirDetail: "East (conceptually encompassing Jia（甲）, Mao（卯）, Yi（乙） mountains for precise Feng Shui orientation)", // Updated
                    palaceDuiDirDetail: "West (conceptually encompassing Geng（庚）, You（酉）, Xin（辛） mountains for precise Feng Shui orientation)", // Updated
                    palaceGenDirDetail: "Northeast (conceptually encompassing Chou（丑）, Gen（艮）, Yin（寅） mountains for precise Feng Shui orientation)", // Updated
                    palaceKanDirDetail: "North (conceptually encompassing Ren（壬）, Zi（子）, Gui（癸） mountains for precise Feng Shui orientation)", // Updated
                    palaceQianDirDetail: "Northwest (conceptually encompassing Xu（戌）, Qian（乾）, Hai（亥） mountains for precise Feng Shui orientation)", // Updated

                    elementWater: "Water", elementWood: "Wood", elementFire: "Fire", elementEarth: "Earth", elementMetal: "Metal",

                    qualitiesXun: "Xun represents Wind, entry, and obedience.", 
                    qualitiesLi: "Li represents Fire, brightness, and beauty.",
                    qualitiesKun: "Kun represents Earth, receptivity, and nourishment.", 
                    qualitiesZhen: "Zhen represents Thunder, action, and initiative.",
                    qualitiesDui: "Dui represents Marsh, joy, and speech.", 
                    qualitiesGen: "Gen represents Mountain, cultivate, and stability.", // Updated
                    qualitiesKan: "Kan represents Water, peril, and wisdom.", 
                    qualitiesQian: "Qian represents Heaven, strength, and leadership.",

                    enhanceXun: "The Wood element in the Southeast can enhance growth and development.",
                    enhanceLi: "The Fire element in the South can enhance fame and recognition.",
                    enhanceKun: "The Earth element in the Southwest can enhance stability and relationships.",
                    enhanceZhen: "The Wood element in the East can enhance motivation and new beginnings.",
                    enhanceDui: "The metal element in the west can enhance the ability of expression and the aura of joy.", // Updated
                    enhanceGen: "The Earth element in the Northeast can enhance knowledge and self-cultivation.",
                    enhanceKan: "The Water element in the North can enhance stress resistance and wisdom.", // Updated
                    enhanceQian: "The metal element in the northwest can enhance the momentum of working hard and striving for progress as well as authority.", // Updated

                    wuXingInteractionsTitle: "Five Elements Interactions", // Updated
                    generatesLabel: "Generates (shēng)", 
                    controlsLabel: "Restricts (kè)", // Updated (was Controls)
                    isGeneratedByLabel: "Is Generated By (bèi shēng)", 
                    isControlledByLabel: "Is Restricted By (bèi kè)", // Updated (was Is Controlled By)
                    
                    gateXiu: "休门 (Xiū Mén) - Rest Door", // Updated
                    gateSheng: "生门 (Shēng Mén) - Growth Door", // Updated
                    gateShang: "伤门 (Shāng Mén) - Injury Door", // Updated
                    gateDu: "杜门 (Dù Mén) - Delusion Door", // Updated
                    gateJing: "景门 (Jǐng Mén) - Scenery Door", // Updated
                    gateSi: "死门 (Sǐ Mén) - Death Door", // Updated
                    gateJing2: "惊门 (Jīng Mén) - Fear Door", // Updated
                    gateKai: "开门 (Kāi Mén) - Open Door", // Updated

                    gateXiuShort: "Rest", 
                    gateShengShort: "Growth", // Updated
                    gateShangShort: "Injury", // Updated
                    gateDuShort: "Delu.", 
                    gateJingShort: "Scen.", 
                    gateSiShort: "Death", 
                    gateJing2Short: "Fear", 
                    gateKaiShort: "Open",

                    gateXiuProperties: "The Rest Door is generally auspicious for rest, recuperation, restoration and spiritual cultivation.", // Updated
                    gateShengProperties: "The Growth Door is generally auspicious for wealth, business, and vitality.", // Updated "Life Gate" to "Growth Door"
                    gateShangProperties: "The Injury Door is often associated with injury, competition, and demands.", // Updated "Harm Gate" to "Injury Door"
                    gateDuProperties: "The Delusion Door is often associated with hiding, obstruction, and technical skills.", // Updated "Delusion Gate" to "Delusion Door"
                    gateJingProperties: "The Scenery Door is often associated with documents, planning, visions and beauty.", // Updated
                    gateSiProperties: "The Death Door is often associated with endings, real estate and stillness.", // Updated
                    gateJing2Properties: "The Fear Door is often associated with eloquence, disputes, legal issues, and panic.", // Updated
                    gateKaiProperties: "The Open Door is generally auspicious for new ventures, travel, and meeting important people.", // Updated "Open Gate" to "Open Door"

                    qimenInteractionTitle: "Qimen Conceptual Interaction",
                    qimenFundamentalState: "Fundamental State: In this view, the {gateName} is in its home palace ({palaceName}), where its element ({gateElement}) aligns with the palace's element ({palaceElement}).", // {gateName} will use "Door"
                    qimenCourseInsight: "Course Insight: The introductory course of Qimen Dunjia and Fengshui systematically explains the core basic theories of Qimen Dunjia and Fengshui geomancy. It deeply integrates the system of judging good and bad luck in Qimen Dunjia into the practice of Fengshui geomancy. Through the comprehensive analysis of human affairs and environmental factors, it helps students master practical methods to seek good fortune and avoid bad luck, and achieve the improvement of personal wealth, career and health luck.", // Updated
                    gateOriginalPalace: "Originates from Palace", // Retained 'Palace' for clarity with Ba Gua context. If "Door Original Palace", it might be confusing.
                    derivedElement: "Derived Element",

                    mountainRen: "Ren", mountainZi: "Zi", mountainGui: "Gui", mountainChou: "Chou", mountainGenM: "Gen", mountainYin: "Yin",
                    mountainJia: "Jia", mountainMao: "Mao", mountainYi: "Yi", mountainChen: "Chen", mountainXunM: "Xun", mountainSiM: "Si",
                    mountainBing: "Bing", mountainWu: "Wu", mountainDing: "Ding", mountainWei: "Wei", mountainKunM: "Kun", mountainShen: "Shen",
                    mountainGeng: "Geng", mountainYou: "You", mountainXin: "Xin", mountainXu: "Xu", mountainQianM: "Qian", mountainHai: "Hai",

                    mountainRenFull: "Ren (壬) Mountain", mountainZiFull: "Zi (子) Mountain", mountainGuiFull: "Gui (癸) Mountain",
                    mountainChouFull: "Chou (丑) Mountain", mountainGenMFull: "Gen (艮) Mountain", mountainYinFull: "Yin (寅) Mountain",
                    mountainJiaFull: "Jia (甲) Mountain", mountainMaoFull: "Mao (卯) Mountain", mountainYiFull: "Yi (乙) Mountain",
                    mountainChenFull: "Chen (辰) Mountain", mountainXunMFull: "Xun (巽) Mountain", mountainSiMFull: "Si (巳) Mountain",
                    mountainBingFull: "Bing (丙) Mountain", mountainWuFull: "Wu (午) Mountain", mountainDingFull: "Ding (丁) Mountain",
                    mountainWeiFull: "Wei (未) Mountain", mountainKunMFull: "Kun (坤) Mountain", mountainShenFull: "Shen (申) Mountain",
                    mountainGengFull: "Geng (庚) Mountain", mountainYouFull: "You (酉) Mountain", mountainXinFull: "Xin (辛) Mountain",
                    mountainXuFull: "Xu (戌) Mountain", mountainQianMFull: "Qian (乾) Mountain", mountainHaiFull: "Hai (亥) Mountain",

                    mountainParentPalace: "Belongs to", mountainDirectionSuffix: "Direction", mountainApproxDegrees: "Approx. Degrees",
                    mountainInheritedElement: "Primary Element",
                    mountainInheritedElementNote: "(from {palaceName} Palace). Specific Mountain elemental nuances will be explored in the 'Qimen / FengShui Foundations' course.", // Course name updated
                    mountainFengShuiImplication: "Feng Shui Implication",
                    mountainCourseRelevance: "Relevance to 'Qimen / FengShui Foundations' Course", // Course name updated
                    mountainCourseRelevanceText: "Course Essential: Accurately identifying the Facing/Sitting Mountain (e.g., {mountainName}) with a Luopan (罗盘) is a critical first step in 'Qimen / FengShui Foundations' for overlaying and interpreting the Qimen Dunjia chart.", // Course name updated
                    qimenGateInThisSector: "Qimen Door in this Sector", // Updated
                    qimenGateInThisSectorSuffix: "(occupying the {palaceName} Palace in this foundational view).",

                    mountainRenImplication: "Ren Mountain: Peak Water energy, North-Northwest. For precise adjustments.",
                    mountainZiImplication: "Zi Mountain: True North, peak Water. Key for orientation.",
                    mountainGuiImplication: "Gui Mountain: Fading Water energy, North-Northeast. Fine-tuning.",
                    mountainChouImplication: "Chou Mountain: Northeast, Earth with Metal. Stability and accumulation.",
                    mountainGenMImplication: "Gen Mountain: True Northeast, Earth's home. Knowledge and stillness.",
                    mountainYinImplication: "Yin Mountain: Northeast, nascent Wood. New beginnings and vitality.",
                    mountainJiaImplication: "Jia Mountain: East, strong Wood. Initiative and progress.",
                    mountainMaoImplication: "Mao Mountain: True East, peak Wood. Prosperity and development.",
                    mountainYiImplication: "Yi Mountain: East, flexible Wood. Planning and adaptability.",
                    mountainChenImplication: "Chen Mountain: Southeast, Earth with Water. Change and opportunity.",
                    mountainXunMImplication: "Xun Mountain: True Southeast, mature Wood. Favorable winds and reputation.",
                    mountainSiMImplication: "Si Mountain: Southeast, nascent Fire. Enthusiasm and dissemination.",
                    mountainBingImplication: "Bing Mountain: South, strong Fire. Brightness and authority.",
                    mountainWuImplication: "Wu Mountain: True South, peak Fire. Zenith and intensity.",
                    mountainDingImplication: "Ding Mountain: South, gentle Fire. Wisdom and subtlety.",
                    mountainWeiImplication: "Wei Mountain: Southwest, Earth with Fire. Nurturing and connections.",
                    mountainKunMImplication: "Kun Mountain: True Southwest, Earth's home. Receptivity and maternal energy.",
                    mountainShenImplication: "Shen Mountain: Southwest, nascent Metal. Resilience and versatility.",
                    mountainGengImplication: "Geng Mountain: West, strong Metal. decisiveness and harvest.",
                    mountainYouImplication: "You Mountain: True West, peak Metal. Achievements and joy.",
                    mountainXinImplication: "Xin Mountain: West, refined Metal. Jewels and charisma.",
                    mountainXuImplication: "Xu Mountain: Northwest, Earth with Metal. Guardianship and storage.",
                    mountainQianMImplication: "Qian Mountain: True Northwest, Metal's home. Leadership and heavenly luck.",
                    mountainHaiImplication: "Hai Mountain: Northwest, nascent Water. Wisdom and flow.",

                    howToUseTitle: "How to Use This App", aboutWuXingTitle: "About Five Elements", // Updated
                    aboutDirectionsTitle: "About Directions, Luopan & 24 Mountains",
                    aboutAppTitle: "About this App & Course Next Steps", glossaryTitle: "Glossary of Terms",
                    howToUseContent: `<p>Welcome to the Later Heaven Ba Gua & Qimen Dunjia Foundations learning tool!</p><ul><li><strong>Click a Ba Gua Cell:</strong> View detailed information.</li><li><strong>Toggle Qimen Gates:</strong> Overlay original Eight Doors.</li><li><strong>Toggle 24 Mountains:</strong> Subdivide palaces into Mountains. Click a Mountain for details.</li><li><strong>Information Panel:</strong> Appears on click.</li><li><strong>Language Switcher:</strong> Select display language.</li></ul>`,
                    aboutWuXingContent: `<h4>Five Elements (五行)</h4><p>The Five Elements (Water, Wood, Fire, Earth, Metal) describe interactions in the material world. They have generating and restricting cycles:</p><p><strong>Generating Cycle (相生 Xiāng Shēng):</strong> <span class="wuxing-diagram-placeholder" data-diagram-type="generating" aria-label="Five Elements Generating Cycle: Water -> Wood -> Fire -> Earth -> Metal -> Water">Water → Wood → Fire → Earth → Metal → Water</span></p><p><strong>Restricting Cycle (相克 Xiāng Kè):</strong> <span class="wuxing-diagram-placeholder" data-diagram-type="controlling" aria-label="Five Elements Restricting Cycle: Water X Fire X Metal X Wood X Earth X Water">Water ✗ Fire ✗ Metal ✗ Wood ✗ Earth ✗ Water</span></p>`, // Updated
                    aboutDirectionsContent: `<h4>Directions, Luopan (罗盘), & 24 Mountains (二十四山)</h4><p>Later Heaven Ba Gua defines 8 directions (45° each). For precision, each is subdivided into 3 "Mountains" (15° each), totaling 24. E.g., North (Kan) has Ren, Zi, Gui Mountains. <span class="luopan-subdivision-placeholder" aria-label="Diagram showing Ba Gua direction subdivided into 24 Mountains"></span> The Luopan is key for measurement.</p>`,
                    aboutAppContent: `<h4>About this App & 'Qimen / FengShui Foundations' Course Next Steps</h4><p>This app helps you learn Ba Gua, Five Elements, and basic Qimen Eight Doors, a foundation for the "Qimen / FengShui Foundations" course.</p><p>The course covers dynamic Qimen charts, 'Si Hai' identification, and practical application.</p>`, // Updated
                    glossaryContent: `<h4>Glossary of Terms</h4><dl><dt>Houtian Ba Gua (后天八卦)</dt><dd>Later Heaven sequence for space/time cycles.</dd><dt>Wu Xing (五行)</dt><dd>Theory of five elements: Water, Wood, Fire, Earth, Metal.</dd><dt>Qimen Dunjia (奇门遁甲)</dt><dd>Ancient divination for forecasting/strategy.</dd><dt>Ba Men (八门)</dt><dd>Eight main "Doors" in Qimen.</dd><dt>24 Mountains (二十四山)</dt><dd>Compass divided into 24 segments of 15°.</dd></dl>`, // Updated Ba Men def
                    
                    palaceInfoSection: "Palace Information",
                    wuXingInfoSection: "Five Elements Information", // Updated
                    qimenGateInfoSection: "Eight Door Information", // Updated
                    mountainInfoSection: "Mountain Information",
                    parentPalaceBriefSection: "Parent Palace (Brief)"
                }
            }
        };

        // --- DOM Elements ---
        const appTitleMain = document.querySelector('.app-title-main');
        const langZhButton = document.getElementById('lang-zh');
        const langEnButton = document.getElementById('lang-en');
        const qimenToggleButton = document.getElementById('qimen-toggle');
        const mountainsToggleButton = document.getElementById('mountains-toggle');
        const baguaGrid = document.getElementById('bagua-grid');
        const infoPanelOverlay = document.getElementById('info-panel-overlay');
        const infoPanel = document.getElementById('info-panel');
        const infoPanelContent = document.getElementById('info-panel-content');
        const infoPanelCloseButton = document.getElementById('info-panel-close');
        const courseNameFooter = document.querySelector('.app-footer p span');

        // --- Helper Functions ---
        const getLang = () => appData.settings.currentLang;
        const T = (key, replacements = {}) => {
            let text = appData.content[getLang()][key] || `MISSING_KEY: ${key}`;
            for (const placeholder in replacements) {
                text = text.replace(new RegExp(`{${placeholder}}`, 'g'), replacements[placeholder]);
            }
            return text;
        };

        // --- Localization ---
        function setLanguage(lang) {
            appData.settings.currentLang = lang;
            localStorage.setItem('fengshuiAppLang', lang);
            document.documentElement.lang = lang === 'zh' ? 'zh-CN' : 'en';
            
            langZhButton.classList.toggle('active', lang === 'zh');
            langZhButton.setAttribute('aria-pressed', lang === 'zh');
            langEnButton.classList.toggle('active', lang === 'en');
            langEnButton.setAttribute('aria-pressed', lang === 'en');
            
            updateAllTexts();
            renderGrid(); 
            if (appData.settings.selectedElementId) { 
                renderInfoPanel(appData.settings.selectedElementId);
            }
        }

        function updateAllTexts() {
            document.title = T('appTitle'); 
            appTitleMain.textContent = T('appTitle');
            courseNameFooter.textContent = T('courseName');

            qimenToggleButton.textContent = T(appData.settings.qimenOverlayActive ? qimenToggleButton.dataset.translateKeyOn : qimenToggleButton.dataset.translateKeyOff);
            mountainsToggleButton.textContent = T(appData.settings.mountainsOverlayActive ? mountainsToggleButton.dataset.translateKeyOn : mountainsToggleButton.dataset.translateKeyOff);
            infoPanelCloseButton.setAttribute('aria-label', T('infoPanelClose'));


            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey;
                if (el.dataset.htmlContent === "true") {
                    el.innerHTML = T(key); 
                    if (key === 'aboutWuXingContent' || key === 'aboutDirectionsContent') {
                        initializeSvgPlaceholders(el);
                    }
                } else if (key && !el.classList.contains('control-button')) { 
                    el.textContent = T(key);
                }
            });
            const langLabel = document.querySelector('.language-switcher span');
            if (langLabel) langLabel.textContent = T('langSwitchLabel');
        }


        // --- Grid Rendering ---
        function renderGrid() {
            baguaGrid.innerHTML = ''; 
            baguaGrid.className = 'bagua-grid-container'; // Reset classes
            if (appData.settings.mountainsOverlayActive) {
                baguaGrid.classList.add('mountains-overlay-active');
            }

            // Defines the visual slot index for circular layout (South/Li at top, clockwise)
            const circularOrderMap = { 
                'li': 0, 'kun': 1, 'dui': 2, 'qian': 3,
                'kan': 4, 'gen': 5, 'zhen': 6, 'xun': 7
            };

            appData.palaceOrder.forEach(palaceId => {
                const palace = appData.palaces[palaceId];
                const cell = document.createElement('div');
                cell.classList.add('grid-cell');
                cell.setAttribute('role', 'gridcell');
                cell.dataset.palaceId = palaceId;

                // Apply transformations for circular layout if mountains overlay is active
                if (appData.settings.mountainsOverlayActive) {
                    cell.style.backgroundColor = 'transparent'; // Outer cells are transparent containers

                    if (palaceId === 'zhonggong') {
                        cell.classList.add('zhonggong');
                        cell.style.position = 'absolute';
                        cell.style.width = '30%'; 
                        cell.style.height = '30%';
                        cell.style.top = '50%';
                        cell.style.left = '50%';
                        cell.style.transform = 'translate(-50%, -50%)';
                        cell.style.borderRadius = '50%';
                        cell.style.backgroundColor = palace.color; // Keep zhonggong color
                    } else {
                        // One of the 8 outer palaces
                        const palaceIndexInCircular = circularOrderMap[palaceId];
                        if (typeof palaceIndexInCircular !== 'undefined') { // Ensure palaceId is in circular map
                            const angleDeg = palaceIndexInCircular * 45; // Li=0, Kun=45,...

                            const gridComputedWidth = baguaGrid.offsetWidth || parseFloat(getComputedStyle(baguaGrid).maxWidth) || 600;
                            const gridRadius = gridComputedWidth / 2;
                            
                            const cellWidth = gridComputedWidth * 0.28; 
                            const cellHeight = gridComputedWidth * 0.20; 
                            const R_cells = gridRadius * 0.70; // Radius for cell centers

                            cell.style.position = 'absolute';
                            cell.style.width = `${cellWidth}px`;
                            cell.style.height = `${cellHeight}px`;
                            cell.style.border = 'none'; // Hide cell border in circular mode
                            
                            const xPos = R_cells * Math.sin(angleDeg * Math.PI / 180);
                            const yPos = -R_cells * Math.cos(angleDeg * Math.PI / 180);

                            cell.style.left = `50%`;
                            cell.style.top = `50%`;
                            cell.style.transform = `translate(-50%, -50%) translate(${xPos}px, ${yPos}px) rotate(${angleDeg}deg)`;
                        }
                    }
                } else { // Original 3x3 grid styling
                    cell.style.backgroundColor = palace.color;
                }

                // --- Content Filling Logic ---
                if (palaceId === 'zhonggong') {
                    cell.classList.add('zhonggong'); // Ensure class is present even if not in circular mode initially
                    cell.setAttribute('tabindex', '-1'); 
                    const zhongGongLabel = document.createElement('span');
                    zhongGongLabel.textContent = T('zhongGongLabel');
                    if (appData.settings.qimenOverlayActive) {
                        zhongGongLabel.innerHTML = `<span class="zhonggong-star" aria-hidden="true">${T('qimenStarSymbol')}</span><br>${T('zhongGongLabel')}`;
                    }
                    cell.appendChild(zhongGongLabel);
                } else { // Outer palaces
                    cell.setAttribute('tabindex', '0');
                    cell.addEventListener('click', handleCellClick);
                    cell.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') handleCellClick(e); });

                    if (appData.settings.mountainsOverlayActive) {
                        // Populate with mountain segments
                        palace.mountains.forEach(mountainId => {
                            const segment = document.createElement('div');
                            segment.classList.add('mountain-segment');
                            segment.dataset.mountainId = mountainId;
                            segment.dataset.palaceId = palaceId; 
                            // segment.style.backgroundColor = palace.color; // Optional: color segments based on palace

                            const mountainChar = document.createElement('span');
                            mountainChar.classList.add('mountain-char');
                            mountainChar.textContent = T(appData.mountains[mountainId].nameKey);
                            segment.appendChild(mountainChar);
                            
                            const palaceInfoCondensed = document.createElement('div');
                            palaceInfoCondensed.classList.add('palace-info-condensed');
                            palaceInfoCondensed.innerHTML = `
                                <span class="trigram-symbol-condensed">${palace.trigramSymbol}</span><br>
                                ${T(palace.nameKey)}
                            `;
                            segment.appendChild(palaceInfoCondensed);

                            if (appData.settings.qimenOverlayActive && palace.gateId) {
                                const gate = appData.gates[palace.gateId];
                                const gateNameOverlay = document.createElement('span');
                                gateNameOverlay.classList.add('gate-name-overlay');
                                gateNameOverlay.textContent = T(gate.shortNameKey);
                                segment.appendChild(gateNameOverlay);
                            }
                            cell.appendChild(segment);
                        });
                    } else { // 3x3 view: Populate with standard palace info
                        const trigramSymbol = document.createElement('span');
                        trigramSymbol.classList.add('trigram-symbol');
                        trigramSymbol.setAttribute('aria-hidden', 'true'); 
                        trigramSymbol.textContent = palace.trigramSymbol;
                        cell.appendChild(trigramSymbol);

                        const palaceName = document.createElement('span');
                        palaceName.classList.add('palace-name');
                        palaceName.textContent = T(palace.nameKey);
                        cell.appendChild(palaceName);

                        const directionName = document.createElement('span');
                        directionName.classList.add('direction-name');
                        directionName.textContent = T(palace.dirKey);
                        cell.appendChild(directionName);

                        if (appData.settings.qimenOverlayActive && palace.gateId) {
                            const gate = appData.gates[palace.gateId];
                            const gateNameOverlay = document.createElement('span');
                            gateNameOverlay.classList.add('gate-name-overlay');
                            let overlayText = T(gate.nameKey).split('(')[0].trim();
                            if (getLang() === 'en') {
                                overlayText = T(gate.shortNameKey);
                            }
                            gateNameOverlay.textContent = overlayText;
                            cell.appendChild(gateNameOverlay);
                        }
                    }
                }
                baguaGrid.appendChild(cell);
            });
            updateSelectedCellVisual();
        }
        
        function updateSelectedCellVisual() {
            document.querySelectorAll('.grid-cell.active-selection, .mountain-segment.active-selection').forEach(el => el.classList.remove('active-selection'));
            if (appData.settings.selectedElementId) {
                const [type, id] = appData.settings.selectedElementId.split('-');
                let targetElement;
                if (type === 'palace') {
                    targetElement = baguaGrid.querySelector(`.grid-cell[data-palace-id="${id}"]`);
                } else if (type === 'mountain') {
                    // In circular mode, the direct parent .grid-cell of a mountain might be hard to highlight distinctively.
                    // Highlighting the segment itself is more precise.
                    targetElement = baguaGrid.querySelector(`.mountain-segment[data-mountain-id="${id}"]`);
                     if (!targetElement && appData.settings.mountainsOverlayActive) { // Fallback for palace selection in circular mode
                        const mountainData = appData.mountains[id];
                        if (mountainData) {
                             targetElement = baguaGrid.querySelector(`.grid-cell[data-palace-id="${mountainData.parentPalaceId}"]`);
                        }
                    }
                }
                if (targetElement) {
                    targetElement.classList.add('active-selection');
                }
            }
        }

        // --- Interaction Handling ---
        function handleCellClick(event) {
            let target = event.currentTarget; 
            if (event.type === 'click') { // More precise target for clicks inside cells
                 target = event.target.closest('.mountain-segment') || event.target.closest('.grid-cell');
            }
            
            if (!target || target.classList.contains('zhonggong')) return;

            let elementId;
            if (target.classList.contains('mountain-segment') && target.dataset.mountainId) {
                elementId = `mountain-${target.dataset.mountainId}`;
            } else if (target.classList.contains('grid-cell') && target.dataset.palaceId) {
                 // If mountains are active but a non-segment part of the cell is clicked (less likely with current CSS)
                 // or if mountains are not active, this is a palace click.
                if (appData.settings.mountainsOverlayActive && !target.querySelector('.mountain-segment')) {
                    // This case should ideally not happen if cells are filled with segments.
                    // Default to palace if somehow a bare cell area in mountain mode is clicked.
                     elementId = `palace-${target.dataset.palaceId}`;
                } else if (!appData.settings.mountainsOverlayActive) {
                     elementId = `palace-${target.dataset.palaceId}`;
                } else { // If mountain-active and clicked on a cell that contains segments, but not a segment itself (e.g. edge)
                    // Try to find a default mountain or just use palace
                    const firstMountain = appData.palaces[target.dataset.palaceId].mountains[1]; // Middle mountain
                    if (firstMountain) {
                         elementId = `mountain-${firstMountain}`;
                    } else {
                         elementId = `palace-${target.dataset.palaceId}`;
                    }
                }
            }


            if (!elementId) return;

            if (appData.settings.selectedElementId === elementId && infoPanelOverlay.classList.contains('visible')) { 
                hideInfoPanel();
            } else {
                appData.settings.selectedElementId = elementId;
                renderInfoPanel(elementId);
                showInfoPanel();
                updateSelectedCellVisual();
            }
        }

        // --- Info Panel ---
        function renderInfoPanel(elementId) {
            infoPanelContent.innerHTML = ''; 
            const [type, id] = elementId.split('-');
            let panelTitle = T('infoPanelTitleDefault');
            let html = '';

            if (type === 'palace') {
                const palace = appData.palaces[id];
                panelTitle = T('infoPanelTitlePalace', { palaceName: T(palace.nameKey) });
                html += `<span class="trigram-symbol-large" aria-hidden="true">${palace.trigramSymbol}</span>`;
                // Panel Title is part of the html string now
                html += `<h2 id="info-panel-title">${panelTitle}</h2>`;
                
                html += `<h3>${T('palaceInfoSection')}</h3>`;
                html += `<p><strong>${T('palaceNameKey', {name: T(palace.nameKey)})}</strong></p>`;
                html += `<p><strong>${T('directionLabel')}:</strong> ${T(palace.dirDetailKey || palace.dirKey)}</p>`;
                const palaceElement = appData.elements[palace.elementId];
                html += `<p><strong>${T('elementLabel')}:</strong> ${T(palaceElement.nameKey)}</p>`;
                if (palace.qualitiesKey) html += `<p><strong>${T('qualitiesLabel')}:</strong> ${T(palace.qualitiesKey)}</p>`;
                if (palace.enhancementKey) html += `<p><strong>${T('enhancementPotentialLabel')}:</strong> ${T(palace.enhancementKey)}</p>`;

                html += `<h3>${T('wuXingInteractionsTitle')}</h3>`;
                html += `<ul>`;
                html += `<li><strong>${T('generatesLabel')}:</strong> ${T(palaceElement.nameKey)} ${T('generatesWording')} ${T(appData.elements[palaceElement.generates].nameKey)} (${T(palaceElement.nameKey).charAt(0)}生${T(appData.elements[palaceElement.generates].nameKey).charAt(0)})</li>`;
                html += `<li><strong>${T('controlsLabel')}:</strong> ${T(palaceElement.nameKey)} ${T('controlsWording')} ${T(appData.elements[palaceElement.controls].nameKey)} (${T(palaceElement.nameKey).charAt(0)}克${T(appData.elements[palaceElement.controls].nameKey).charAt(0)})</li>`;
                html += `<li><strong>${T('isGeneratedByLabel')}:</strong> ${T(palaceElement.nameKey)} ${T('isGeneratedByWording')} ${T(appData.elements[palaceElement.generatedBy].nameKey)} (${T(appData.elements[palaceElement.generatedBy].nameKey).charAt(0)}生${T(palaceElement.nameKey).charAt(0)})</li>`;
                html += `<li><strong>${T('isControlledByLabel')}:</strong> ${T(palaceElement.nameKey)} ${T('isControlledByWording')} ${T(appData.elements[palaceElement.controlledBy].nameKey)} (${T(appData.elements[palaceElement.controlledBy].nameKey).charAt(0)}克${T(palaceElement.nameKey).charAt(0)})</li>`;
                html += `</ul>`;

                if (appData.settings.qimenOverlayActive && palace.gateId) {
                    const gate = appData.gates[palace.gateId];
                    const gateElement = appData.elements[gate.elementId];
                    html += `<hr>`;
                    html += `<h3>${T('qimenGateInfoSection')}</h3>`;
                    html += `<p><strong>${T('gateNameLabel')}:</strong> ${T(gate.nameKey)}</p>`;
                    html += `<p><strong>${T(getLang() === 'en' ? 'doorOriginalPalaceLabel' : 'gateOriginalPalace')}:</strong> ${T(appData.palaces[gate.originalPalaceId].nameKey)}. <strong>${T('derivedElement')}:</strong> ${T(gateElement.nameKey)}.</p>`;
                    html += `<p><strong>${T('gatePropertiesLabel')}:</strong> ${T(gate.propertiesKey)}</p>`;
                    html += `<h4>${T('qimenInteractionTitle')}</h4>`;
                    html += `<p>${T('qimenFundamentalState', { gateName: T(gate.nameKey), palaceName: T(palace.nameKey), gateElement: T(gateElement.nameKey), palaceElement: T(palaceElement.nameKey) })}</p>`;
                    html += `<p>${T('qimenCourseInsight')}</p>`;
                }

            } else if (type === 'mountain') {
                const mountain = appData.mountains[id];
                const parentPalace = appData.palaces[mountain.parentPalaceId];
                const parentPalaceElement = appData.elements[parentPalace.elementId];
                panelTitle = T('infoPanelTitleMountain', { mountainName: T(mountain.fullNameKey) });

                html += `<h2 id="info-panel-title">${panelTitle}</h2>`;
                
                html += `<h3>${T('mountainInfoSection')}</h3>`;
                html += `<p><strong>${T('mountainParentPalace')}:</strong> ${T(parentPalace.nameKey)} (${T(parentPalace.dirKey)} ${T('mountainDirectionSuffix')})</p>`;
                html += `<p><strong>${T('mountainApproxDegrees')}:</strong> ${mountain.degreeRange}</p>`;
                html += `<p><strong>${T('mountainInheritedElement')}:</strong> ${T(parentPalaceElement.nameKey)} ${T('mountainInheritedElementNote', { palaceName: T(parentPalace.nameKey) })}</p>`;
                html += `<p><strong>${T('mountainFengShuiImplication')}:</strong> ${T(mountain.implicationKey)}</p>`;
                html += `<p><strong>${T('mountainCourseRelevance')}:</strong> ${T('mountainCourseRelevanceText', { mountainName: T(mountain.nameKey) })}</p>`;

                let detailsOpen = !(appData.settings.qimenOverlayActive); 

                html += `<details class="info-panel-section-collapsible" ${detailsOpen ? 'open' : ''}>`;
                html += `<summary>${T('parentPalaceBriefSection')}</summary>`;
                html += `<div>`; 
                html += `<p><span class="trigram-symbol-large" style="font-size:2em;float:none;display:inline-block;">${parentPalace.trigramSymbol}</span> <strong>${T(parentPalace.nameKey)}</strong> - ${T(parentPalace.dirKey)}</p>`;
                html += `<p><strong>${T('elementLabel')}:</strong> ${T(parentPalaceElement.nameKey)}</p>`;
                html += `<p><em>${T('wuXingInteractionsTitleBrief')}:</em> ${T(parentPalaceElement.nameKey)} ${T('generatesWording')} ${T(appData.elements[parentPalaceElement.generates].nameKey)}, ${T('controlsWording')} ${T(appData.elements[parentPalaceElement.controls].nameKey)}.</p>`;
                html += `</div></details>`;
                

                if (appData.settings.qimenOverlayActive && parentPalace.gateId) {
                    const gate = appData.gates[parentPalace.gateId];
                    const gateElement = appData.elements[gate.elementId];
                    const palaceElementForGateContext = appData.elements[parentPalace.elementId];
                    
                    html += `<details class="info-panel-section-collapsible" open>`; 
                    html += `<summary>${T('qimenGateInfoSection')}</summary>`;
                    html += `<div>`;
                    html += `<p><strong>${T(getLang() === 'en' ? 'qimenDoorInThisSectorLabel' : 'qimenGateInThisSector')}:</strong> ${T(gate.nameKey)} ${T(getLang() === 'en' ? 'qimenDoorSuffixText' : 'qimenGateInThisSectorSuffix', { palaceName: T(parentPalace.nameKey) })}</p>`;
                    html += `<p><strong>${T(getLang() === 'en' ? 'doorOriginalPalaceLabel' : 'gateOriginalPalace')}:</strong> ${T(appData.palaces[gate.originalPalaceId].nameKey)}. <strong>${T('derivedElement')}:</strong> ${T(gateElement.nameKey)}.</p>`;
                    html += `<p><strong>${T('gatePropertiesLabel')}:</strong> ${T(gate.propertiesKey)}</p>`;
                    html += `<h4>${T('qimenInteractionTitle')}</h4>`;
                    html += `<p>${T('qimenFundamentalState', { gateName: T(gate.nameKey), palaceName: T(parentPalace.nameKey), gateElement: T(gateElement.nameKey), palaceElement: T(palaceElementForGateContext.nameKey) })}</p>`;
                    html += `<p>${T('qimenCourseInsight')}</p>`;
                    html += `</div></details>`;
                }
            }
            infoPanelContent.innerHTML = html; 
        }


        function showInfoPanel() {
            infoPanelOverlay.classList.add('visible');
            infoPanelCloseButton.focus(); 
            document.addEventListener('keydown', handleEscapeKey);
        }

        function hideInfoPanel() {
            infoPanelOverlay.classList.remove('visible');
            // Do not nullify selectedElementId here if we want to re-render panel on toggle
            // appData.settings.selectedElementId = null; 
            // updateSelectedCellVisual(); // Keep visual selection if panel is just hidden by toggle
            document.removeEventListener('keydown', handleEscapeKey);
        }

        function handleEscapeKey(event) {
            if (event.key === 'Escape') {
                hideInfoPanel();
                appData.settings.selectedElementId = null; // Clear selection on ESC
                updateSelectedCellVisual();
            }
        }
        
        function addStaticContentTranslations() {
            appData.content.zh.palaceNameKey = "卦宫名称";
            appData.content.en.palaceNameKey = "Palace Name";
            appData.content.zh.directionLabel = "方向";
            appData.content.en.directionLabel = "Direction";
            appData.content.zh.elementLabel = "五行";
            appData.content.en.elementLabel = "Element";
            appData.content.zh.qualitiesLabel = "基本性质";
            appData.content.en.qualitiesLabel = "General Qualities";
            appData.content.zh.enhancementPotentialLabel = "可增强";
            appData.content.en.enhancementPotentialLabel = "Enhancement Potential";
            appData.content.zh.generatesWording = "生";
            appData.content.en.generatesWording = "generates";
            appData.content.zh.controlsWording = "克"; // This is 克
            appData.content.en.controlsWording = "restricts"; // Updated based on diff logic for English
            appData.content.zh.isGeneratedByWording = "被";
            appData.content.en.isGeneratedByWording = "is generated by";
            appData.content.zh.isControlledByWording = "被"; // This is 被克
            appData.content.en.isControlledByWording = "is restricted by"; // Updated based on diff logic for English
            appData.content.zh.wuXingInteractionsTitleBrief = "五行简述";
            appData.content.en.wuXingInteractionsTitleBrief = "Five Elements Brief"; // Updated

            appData.content.zh.gateNameLabel = "门名称";
            appData.content.en.gateNameLabel = "Door Name"; // Updated
            appData.content.zh.gatePropertiesLabel = "基本性质"; 
            appData.content.en.gatePropertiesLabel = "General Properties"; 
            appData.content.en.doorOriginalPalaceLabel = "Originates from Palace"; // New for English to use "Door" contextually
            appData.content.en.qimenDoorInThisSectorLabel = "Qimen Door in this Sector"; // New
            appData.content.en.qimenDoorSuffixText = "(occupying the {palaceName} Palace in this foundational view)."; // New

        }


        // --- SVG Diagram Initializers ---
        function createWuXingGeneratingSVG() {
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("viewBox", "0 0 300 200");
            svg.setAttribute("width", "250");
            svg.setAttribute("height", "150");
            svg.setAttribute("aria-label", T('wuXingGeneratingCycleAriaLabel') || "Wu Xing Generating Cycle Diagram");

            const elements = [
                { id: 'water', textKey: 'elementWater', x: 50, y: 150 },
                { id: 'wood', textKey: 'elementWood', x: 30, y: 50 },
                { id: 'fire', textKey: 'elementFire', x: 150, y: 20 },
                { id: 'earth', textKey: 'elementEarth', x: 270, y: 50 },
                { id: 'metal', textKey: 'elementMetal', x: 250, y: 150 }
            ];
            const arrows = [
                { from: 'water', to: 'wood' }, { from: 'wood', to: 'fire' },
                { from: 'fire', to: 'earth' }, { from: 'earth', to: 'metal' },
                { from: 'metal', to: 'water' }
            ];

            const defs = document.createElementNS(svgNS, "defs");
            const marker = document.createElementNS(svgNS, "marker");
            marker.setAttribute("id", "arrowhead-generating");
            marker.setAttribute("markerWidth", "10");
            marker.setAttribute("markerHeight", "7");
            marker.setAttribute("refX", "0");
            marker.setAttribute("refY", "3.5");
            marker.setAttribute("orient", "auto");
            const polygon = document.createElementNS(svgNS, "polygon");
            polygon.setAttribute("points", "0 0, 10 3.5, 0 7");
            polygon.style.fill = '#333';
            marker.appendChild(polygon);
            defs.appendChild(marker);
            svg.appendChild(defs);
            
            elements.forEach(el => {
                const circle = document.createElementNS(svgNS, "circle");
                circle.setAttribute("cx", el.x);
                circle.setAttribute("cy", el.y);
                circle.setAttribute("r", "20");
                circle.style.fill = '#f0f0f0';
                circle.style.stroke = '#333';
                circle.style.strokeWidth = '1';
                svg.appendChild(circle);

                const text = document.createElementNS(svgNS, "text");
                text.setAttribute("x", el.x);
                text.setAttribute("y", el.y + 5);
                text.setAttribute("text-anchor", "middle");
                text.style.fontSize = '12px';
                text.textContent = T(el.textKey).charAt(0);
                svg.appendChild(text);
            });

            arrows.forEach(arrow => {
                const fromEl = elements.find(e => e.id === arrow.from);
                const toEl = elements.find(e => e.id === arrow.to);
                const line = document.createElementNS(svgNS, "line");
                const angle = Math.atan2(toEl.y - fromEl.y, toEl.x - fromEl.x);
                const radius = 20;
                line.setAttribute("x1", fromEl.x + radius * Math.cos(angle));
                line.setAttribute("y1", fromEl.y + radius * Math.sin(angle));
                line.setAttribute("x2", toEl.x - radius * Math.cos(angle));
                line.setAttribute("y2", toEl.y - radius * Math.sin(angle));
                line.style.stroke = '#333';
                line.style.strokeWidth = '1.5';
                line.setAttribute("marker-end", "url(#arrowhead-generating)");
                svg.appendChild(line);
            });
            return svg;
        }

        function createWuXingControllingSVG() {
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("viewBox", "0 0 300 200");
            svg.setAttribute("width", "250");
            svg.setAttribute("height", "150");
            svg.setAttribute("aria-label", T('wuXingControllingCycleAriaLabel') || "Wu Xing Controlling Cycle Diagram");

            const elements = [ 
                { id: 'water', textKey: 'elementWater', x: 50, y: 150 },  
                { id: 'wood', textKey: 'elementWood', x: 30, y: 50 },    
                { id: 'fire', textKey: 'elementFire', x: 150, y: 20 },   
                { id: 'earth', textKey: 'elementEarth', x: 270, y: 50 },  
                { id: 'metal', textKey: 'elementMetal', x: 250, y: 150 } 
            ];
            const arrows = [ // Water controls Fire, Fire controls Metal, Metal controls Wood, Wood controls Earth, Earth controls Water
                { from: 'water', to: 'fire' }, { from: 'fire', to: 'metal' },
                { from: 'metal', to: 'wood' }, { from: 'wood', to: 'earth' },
                { from: 'earth', to: 'water' }
            ];

            const defs = document.createElementNS(svgNS, "defs");
            const marker = document.createElementNS(svgNS, "marker");
            marker.setAttribute("id", "arrowhead-controlling");
            marker.setAttribute("markerWidth", "10");
            marker.setAttribute("markerHeight", "7");
            marker.setAttribute("refX", "0");
            marker.setAttribute("refY", "3.5");
            marker.setAttribute("orient", "auto");
            const polygon = document.createElementNS(svgNS, "polygon");
            polygon.setAttribute("points", "0 0, 10 3.5, 0 7");
            polygon.style.fill = 'red';
            marker.appendChild(polygon);
            defs.appendChild(marker);
            svg.appendChild(defs);

            elements.forEach(el => {
                const circle = document.createElementNS(svgNS, "circle");
                circle.setAttribute("cx", el.x);
                circle.setAttribute("cy", el.y);
                circle.setAttribute("r", "20");
                circle.style.fill = '#f0f0f0';
                circle.style.stroke = '#333';
                circle.style.strokeWidth = '1';
                svg.appendChild(circle);

                const text = document.createElementNS(svgNS, "text");
                text.setAttribute("x", el.x);
                text.setAttribute("y", el.y + 5);
                text.setAttribute("text-anchor", "middle");
                text.style.fontSize = '12px';
                text.textContent = T(el.textKey).charAt(0);
                svg.appendChild(text);
            });

            arrows.forEach(arrow => {
                const fromEl = elements.find(e => e.id === arrow.from);
                const toEl = elements.find(e => e.id === arrow.to);
                const line = document.createElementNS(svgNS, "line");
                const angle = Math.atan2(toEl.y - fromEl.y, toEl.x - fromEl.x);
                const radius = 20;
                line.setAttribute("x1", fromEl.x + radius * Math.cos(angle));
                line.setAttribute("y1", fromEl.y + radius * Math.sin(angle));
                line.setAttribute("x2", toEl.x - radius * Math.cos(angle));
                line.setAttribute("y2", toEl.y - radius * Math.sin(angle));
                line.style.stroke = 'red';
                line.style.strokeWidth = '1.5';
                line.setAttribute("marker-end", "url(#arrowhead-controlling)");
                svg.appendChild(line);
            });
            return svg;
        }
        
        function createLuopanSubdivisionSVG() {
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("viewBox", "-120 -120 240 240"); 
            svg.setAttribute("width", "200");
            svg.setAttribute("height", "200");
            svg.setAttribute("aria-label", T('luopanSubdivisionAriaLabel') || "Luopan 24 Mountains Subdivision Diagram");

            const R = 100; 

            for (let i = 0; i < 8; i++) {
                const angle = (i * 45 - 90) * Math.PI / 180; 
                const line = document.createElementNS(svgNS, "line");
                line.setAttribute("x1", "0");
                line.setAttribute("y1", "0");
                line.setAttribute("x2", R * Math.cos(angle));
                line.setAttribute("y2", R * Math.sin(angle));
                line.style.stroke = '#aaa';
                line.style.strokeWidth = '1';
                svg.appendChild(line);
            }

            for (let i = 0; i < 24; i++) {
                const angle = (i * 15 - 90 + 7.5) * Math.PI / 180; 
                const line = document.createElementNS(svgNS, "line");
                line.setAttribute("x1", "0");
                line.setAttribute("y1", "0");
                line.setAttribute("x2", R * Math.cos(angle));
                line.setAttribute("y2", R * Math.sin(angle));
                line.style.stroke = '#ccc';
                line.style.strokeDasharray = "2,2";
                line.style.strokeWidth = '0.5';
                svg.appendChild(line);
                
                if (i < 3) { 
                    const text = document.createElementNS(svgNS, "text");
                    const textAngle = (i * 15 - 90 + 7.5) * Math.PI / 180;
                    text.setAttribute("x", (R - 15) * Math.cos(textAngle));
                    text.setAttribute("y", (R - 15) * Math.sin(textAngle) + 4 ); 
                    text.setAttribute("text-anchor", "middle");
                    text.style.fontSize = '10px';
                    text.textContent = ['癸', '子', '壬'][i]; 
                    svg.appendChild(text);
                }
            }
            
            const outerCircle = document.createElementNS(svgNS, "circle");
            outerCircle.setAttribute("cx", "0");
            outerCircle.setAttribute("cy", "0");
            outerCircle.setAttribute("r", R);
            outerCircle.style.fill = 'none';
            outerCircle.style.stroke = '#333';
            outerCircle.style.strokeWidth = '1.5';
            svg.appendChild(outerCircle);

            const innerCircle = document.createElementNS(svgNS, "circle");
            innerCircle.setAttribute("cx", "0");
            innerCircle.setAttribute("cy", "0");
            innerCircle.setAttribute("r", R * 0.3); 
            innerCircle.style.fill = '#f0f0f0';
            innerCircle.style.stroke = '#333';
            innerCircle.style.strokeWidth = '1';
            svg.appendChild(innerCircle);
            
            const northMark = document.createElementNS(svgNS, "text");
            northMark.setAttribute("x", "0");
            northMark.setAttribute("y", -R - 5);
            northMark.setAttribute("text-anchor", "middle");
            northMark.style.fontSize = '12px';
            northMark.textContent = T('dirN');
            svg.appendChild(northMark);


            return svg;
        }

        function initializeSvgPlaceholders(parentElement = document) {
            appData.content.zh.wuXingGeneratingCycleAriaLabel = "五行相生图";
            appData.content.en.wuXingGeneratingCycleAriaLabel = "Five Elements Generating Cycle Diagram";
            appData.content.zh.wuXingControllingCycleAriaLabel = "五行相克图";
            appData.content.en.wuXingControllingCycleAriaLabel = "Five Elements Restricting Cycle Diagram"; // Updated
            appData.content.zh.luopanSubdivisionAriaLabel = "罗盘二十四山示意图";
            appData.content.en.luopanSubdivisionAriaLabel = "Luopan 24 Mountains Subdivision Diagram";

            parentElement.querySelectorAll('.wuxing-diagram-placeholder[data-diagram-type="generating"]').forEach(ph => {
                ph.innerHTML = ''; 
                ph.appendChild(createWuXingGeneratingSVG());
            });
            parentElement.querySelectorAll('.wuxing-diagram-placeholder[data-diagram-type="controlling"]').forEach(ph => {
                ph.innerHTML = '';
                ph.appendChild(createWuXingControllingSVG());
            });
            parentElement.querySelectorAll('.luopan-subdivision-placeholder').forEach(ph => {
                ph.innerHTML = '';
                ph.appendChild(createLuopanSubdivisionSVG());
            });
        }


        // --- Event Listeners ---
        langZhButton.addEventListener('click', () => setLanguage('zh'));
        langEnButton.addEventListener('click', () => setLanguage('en'));

        qimenToggleButton.addEventListener('click', () => {
            appData.settings.qimenOverlayActive = !appData.settings.qimenOverlayActive;
            qimenToggleButton.classList.toggle('active', appData.settings.qimenOverlayActive);
            qimenToggleButton.setAttribute('aria-pressed', appData.settings.qimenOverlayActive);
            qimenToggleButton.textContent = T(appData.settings.qimenOverlayActive ? qimenToggleButton.dataset.translateKeyOn : qimenToggleButton.dataset.translateKeyOff);
            renderGrid(); // Re-render grid for Qimen overlay changes
            if (infoPanelOverlay.classList.contains('visible') && appData.settings.selectedElementId) {
                renderInfoPanel(appData.settings.selectedElementId); 
            }
        });

        mountainsToggleButton.addEventListener('click', () => {
            appData.settings.mountainsOverlayActive = !appData.settings.mountainsOverlayActive;
            mountainsToggleButton.classList.toggle('active', appData.settings.mountainsOverlayActive);
            mountainsToggleButton.setAttribute('aria-pressed', appData.settings.mountainsOverlayActive);
            mountainsToggleButton.textContent = T(appData.settings.mountainsOverlayActive ? mountainsToggleButton.dataset.translateKeyOn : mountainsToggleButton.dataset.translateKeyOff);
            
            // If switching from circular (mountains active) to grid, and a mountain was selected,
            // it might be more intuitive to clear selection or switch to its parent palace.
            if (!appData.settings.mountainsOverlayActive && appData.settings.selectedElementId && appData.settings.selectedElementId.startsWith('mountain-')) {
                const mountainId = appData.settings.selectedElementId.split('-')[1];
                const parentPalaceId = appData.mountains[mountainId]?.parentPalaceId;
                if (parentPalaceId) {
                    appData.settings.selectedElementId = `palace-${parentPalaceId}`;
                } else {
                    appData.settings.selectedElementId = null; // Clear if no parent found
                }
            }
            
            renderGrid(); // This will apply/remove circular layout styles and positions
            
            if (appData.settings.selectedElementId) {
                 if (infoPanelOverlay.classList.contains('visible')) {
                    renderInfoPanel(appData.settings.selectedElementId); // Re-render panel with current selection
                 }
                 updateSelectedCellVisual(); // Update visual selection on grid
            } else {
                hideInfoPanel(); // Hide panel if selection was cleared
            }
        });

        infoPanelCloseButton.addEventListener('click', () => {
            hideInfoPanel();
            appData.settings.selectedElementId = null; // Clear selection on panel close
            updateSelectedCellVisual();
        });
        infoPanelOverlay.addEventListener('click', (event) => {
            if (event.target === infoPanelOverlay) { 
                hideInfoPanel();
                appData.settings.selectedElementId = null; // Clear selection on overlay click
                updateSelectedCellVisual();
            }
        });
        
        document.querySelectorAll('.info-section summary').forEach(summary => {
            summary.addEventListener('click', (e) => {
                // Standard browser behavior handles toggle
            });
        });


        // --- Initialization ---
        function init() {
            const savedLang = localStorage.getItem('fengshuiAppLang') || appData.settings.defaultLang;
            addStaticContentTranslations(); 
            setLanguage(savedLang); // This calls renderGrid and updateAllTexts
            initializeSvgPlaceholders(); 
            // const howToUseSection = document.getElementById('how-to-use');
            // if (howToUseSection && !localStorage.getItem('fengshuiAppVisited')) {
                 // howToUseSection.setAttribute('open', true);
                 // localStorage.setItem('fengshuiAppVisited', 'true'); 
            // }
        }

        init();
    });
    </script>
</body>
</html>
